<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Bandersnatch</title>
<style>
body { margin: auto; text-align: center; margin-top: 50px; }
.frame { margin: auto; height: 70%; width: 70%; }
video { width: 100%; height: 100%; }
.controls { margin: auto; width: 100%; }

ul {
    display: flex;
    align-items: stretch;
    justify-content: space-around;
    width: 100%;
    margin: 0;
    padding: 0;
	font: 20px sans-serif;
}

li {
    display: block;
    flex: 0 1 auto;
    list-style-type: none;
}

</style>

<!-- downloaded from https://gist.github.com/jonluca/860f3f445e7d84054822276fd058301a/, added jsonp first line: callback= -->
<script src="bandersnatch.js"></script>

<script>

var data = callback.videos['80988062'].interactiveVideoMoments.value;
var choicePoints = data.choicePointNavigatorMetadata.choicePointsMetadata.choicePoints;
var segmentGroups = data.segmentGroups;
var momentsBySegment = data.momentsBySegment;

function ms2str(ms) {
	return new Date(ms).toUTCString().split(' ')[4];
}

function getSegmentMs(segmentId) {
	if (segmentId.startsWith('nsg-')) {
		segmentGroupId = segmentId.substring(4);
		segs = segmentGroups[segmentGroupId];
		for (seg of segs) {
			console.log(seg);
			return getSegmentMs(seg);
		}
	} else {
		return momentsBySegment[segmentId][0].startMs;
	}
}

function getChoices(r) {
	var counter = 0;
	var caption = '';
	for (i in r.choices) {
		var text = r.choices[i].text
		text += '('+r.choices[i].id+')';
		caption += ' ';
		caption += counter==r.defaultChoiceIndex ? '['+text+']' : text;
		counter ++;
	}

	if (caption) {
		caption += ' timeout ';
		caption += ms2str(r.choiceActivationThresholdMS);
	}

	return caption;
}

function parseMoments() {

	var segments = []
	for(const [k, v] of Object.entries(data.momentsBySegment)) { segments.push(k); }
	segments.sort();

	c = document.getElementById("chapters");
	for (segmentId of segments) {
		var r = momentsBySegment[segmentId][0];
		var caption = '';
		caption += ms2str(r.startMs);
		caption += ' ';
		caption += segmentId;
		caption += ' ';
		caption += getChoices(r);
		c.add(new Option(caption, segmentId));
	}
}

function parseChoicePoints() {

	var segments = []
	for(const [k, v] of Object.entries(choicePoints)) { segments.push(k); }
	segments.sort();
	console.log(segments);

	var c = document.getElementById("chapters");

	for (segmentId of segments) {
		var r = choicePoints[segmentId];
		var ms = r.startTimeMs;
		var caption = segmentId + ' (' + ms2str(ms) +') '+ r.description + ' ' + r.choices.join(' / ');
		c.add(new Option(caption, segmentId));
	}

	//data = callback.videos['80988062'].interactiveVideoMoments.value.momentsBySegment;
	//console.log(data);
/*
	data = callback.videos['80988062'].interactiveVideoMoments.value.choicePointNavigatorMetadata.choicePointsMetadata.choicePoints;
	for(const [k, v] of Object.entries(data)) {
		var ms = v.startTimeMs + 10*1000;
		var caption = v.description + ' ' + ms2str(ms) + ' ' + k + ' ' + ' ' + v.choices[0]+' / ' +v.choices[1];
		document.getElementById("chapters").add(new Option(caption, ms));
	}
*/

}


function run() {
	console.log(data);
	c = document.getElementById("chapters");
	parseMoments();
	//parseChoicePoints();
	//cb();
}

function findTime(s) {
	for(const [key, value] of Object.entries(chapters)) {
		if (value==s)
			return ts[key];
	}
	return 0;
}

function makeURL(segmentId, s) {
	return '<a href="javascript:jump('+t+')">'+s+'</a>';
}

function ask() {
	var segmentId = c[c.selectedIndex].value;

	a = ['', '', '']

	data = callback.videos['80988062'].interactiveVideoMoments.value.momentsBySegment;
	var r = data[segmentId][0];

	var ul = document.getElementById("choices");
	ul.innerHTML='';
	for (i in r.choices) {
		var li = document.createElement("li");
		var a = document.createElement("a");
		a.textContent = r.choices[i].text;
		a.setAttribute('href', 'javascript:jump("'+r.choices[i].id+'")');
		li.appendChild(a);
		ul.appendChild(li);
	}
}

function cb() {
	var ms = document.getElementById("video").currentTime * 1000.0;
	var c = document.getElementById("chapters");
	var index = c.selectedIndex;
	[].forEach.call(c, function (x, i) {
		if (ms>=getSegmentMs(x.value))
			index = i;
	});

	if (c.selectedIndex != index) {
		c.selectedIndex = index;
		ask();
	}

	setTimeout(cb, 100);
}

function update() {
	var ms = document.getElementById("video").currentTime * 1000.0;

	var index = c.selectedIndex;
	[].forEach.call(c, function (x, i) {
		if (ms >= getSegmentMs(x.value))
			index = i;
	});

	if (c.selectedIndex != index) {
		c.selectedIndex = index;
	}
}

function jump(segmentId) {
	console.log('Jump to '+segmentId);
	var ms = getSegmentMs(segmentId);
	document.getElementById("video").currentTime = ms / 1000.0;
	ask();
	//update();
}

</script>
</head>
<body onload=run()>
<div>
	<div class="frame">
		<select id="chapters" onchange=jump(this[this.selectedIndex].value)><option value="">Select episode</option></select>
		<video id="video" autoplay controls src="Black.Mirror.Bandersnatch.2018.720p.WEB-DL.x264.DUAL.mkv"></video>
		<div class="controls">
			<div id="progress"></div>
			<div class="buttons">
				<ul id="choices">
				<li>.</li>
				<li>.</li>
				</ul>
			</div>
		</div>
	</div>
</div>
</body>
</html>
